<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KFCåˆ¸æ–‡æ¡ˆä¿®æ”¹ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .header {
            background: #e4002b;
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .input-section {
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
            font-size: 14px;
        }

        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            transition: border-color 0.3s;
        }

        textarea:focus {
            outline: none;
            border-color: #e4002b;
        }

        input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #e4002b;
        }

        .btn {
            background: #e4002b;
            color: white;
            padding: 14px 40px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-block;
        }

        .btn:hover {
            background: #c5001f;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(228, 0, 43, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .result-section {
            display: none;
            margin-top: 30px;
            padding-top: 30px;
            border-top: 2px solid #e0e0e0;
        }

        .result-section.show {
            display: block;
        }

        .result-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
        }

        .result-box {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 6px;
            border-left: 4px solid #e4002b;
            margin-bottom: 20px;
        }

        .result-text {
            white-space: pre-wrap;
            line-height: 1.8;
            color: #333;
            font-size: 14px;
        }
        
        .highlight {
            background-color: #ffeb3b;
            padding: 2px 4px;
            border-radius: 3px;
            font-weight: 500;
            cursor: pointer;
            position: relative;
            transition: background-color 0.2s;
        }
        
        .highlight:hover {
            background-color: #fdd835;
        }
        
        .tooltip {
            position: fixed;
            background: #333;
            color: white;
            padding: 12px 16px;
            border-radius: 6px;
            font-size: 13px;
            max-width: 400px;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            pointer-events: none;
            line-height: 1.6;
            display: none;
        }
        
        .tooltip::before {
            content: 'ä¿®æ”¹åï¼š';
            display: block;
            font-weight: bold;
            color: #fdd835;
            margin-bottom: 6px;
        }
        
        .view-mode-select {
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            transition: border-color 0.3s;
        }
        
        .view-mode-select:focus {
            outline: none;
            border-color: #e4002b;
        }
        
        .view-mode-select:hover {
            border-color: #e4002b;
        }

        .modification-list {
            list-style: none;
        }

        .modification-item {
            background: white;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
            transition: all 0.3s;
        }
        
        .modification-item.flash {
            animation: flash 0.6s ease-in-out 2;
        }
        
        @keyframes flash {
            0%, 100% {
                border-color: #e0e0e0;
                box-shadow: none;
            }
            50% {
                border-color: #e4002b;
                box-shadow: 0 0 15px rgba(228, 0, 43, 0.5);
            }
        }

        .modification-label {
            font-weight: bold;
            color: #e4002b;
            margin-bottom: 5px;
            font-size: 12px;
        }

        .modification-content {
            color: #666;
            line-height: 1.6;
            font-size: 14px;
        }
        
        .modification-content input,
        .modification-content textarea {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            font-size: 14px;
            margin-top: 4px;
            font-family: inherit;
        }
        
        .modification-content textarea {
            resize: vertical;
            min-height: 60px;
        }
        
        .edit-btn {
            background: #f0f0f0;
            border: 1px solid #ddd;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            margin-left: 10px;
            transition: all 0.2s;
        }
        
        .edit-btn:hover {
            background: #e0e0e0;
        }
        
        .edit-btn.active {
            background: #e4002b;
            color: white;
            border-color: #e4002b;
        }
        
        .diff-highlight {
            background-color: #ffeb3b;
            padding: 1px 3px;
            border-radius: 2px;
            font-weight: 500;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #e4002b;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            color: #856404;
        }

        .quick-ops {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .quick-btn {
            background: #f0f0f0;
            color: #333;
            padding: 8px 16px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quick-btn:hover {
            background: #e4002b;
            color: white;
            border-color: #e4002b;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1>ğŸ— KFCåˆ¸æ–‡æ¡ˆä¿®æ”¹ç³»ç»Ÿ</h1>
                    <p>æ™ºèƒ½ä¿®æ”¹è‚¯å¾·åŸºå…‘æ¢åˆ¸æ–‡æ¡ˆ</p>
                </div>
                <button class="btn" onclick="backToTasks()" style="background: #f0f0f0; color: #333;">
                    â† è¿”å›ä»»åŠ¡åˆ—è¡¨
                </button>
            </div>
        </div>

        <div class="content">
           <!-- è¾“å…¥åŒºåŸŸï¼šå­ä»»åŠ¡è¯¦æƒ…é¡µé¢ä¸å…è®¸å‘èµ·ä¿®æ”¹ï¼Œéšè— -->
           <div class="input-section" style="display: none;">
                <div class="form-group">
                    <label for="activityCode">æ´»åŠ¨ç¼–ç ï¼ˆActivity Codeï¼‰ï¼š</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="activityCode" placeholder="è¯·è¾“å…¥æ´»åŠ¨ç¼–ç ï¼Œä¾‹å¦‚ï¼šTEST001" style="flex: 1;">
                        <button class="btn" onclick="loadOriginalText()" style="padding: 12px 30px;">
                            åŠ è½½åŸæ–‡
                        </button>
                    </div>
                    <div style="margin-top: 8px; font-size: 12px; color: #666;">
                        æç¤ºï¼šè¾“å…¥æ´»åŠ¨ç¼–ç åç‚¹å‡»â€œåŠ è½½åŸæ–‡â€æŒ‰é’®ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨è·å–å¯¹åº”çš„åˆ¸æ–‡æ¡ˆ
                    </div>
                </div>
        
                <div class="form-group">
                    <label for="originalText">åŸå§‹åˆ¸æ–‡æ¡ˆï¼š</label>
                    <textarea id="originalText" rows="12" placeholder="è¯·è¾“å…¥æ´»åŠ¨ç¼–ç åŠ è½½åŸæ–‡ï¼Œæˆ–ç›´æ¥ç²˜è´´åˆ¸æ–‡æ¡ˆå†…å®¹..."></textarea>
                </div>
        
                <div class="form-group">
                    <label for="operation">æ“ä½œæŒ‡ä»¤ï¼š</label>
                    <div class="quick-ops">
                        <button class="quick-btn" onclick="setOperation('åˆ é™¤é»„é‡‘è„†çš®é¸¡')">åˆ é™¤é»„é‡‘è„†çš®é¸¡</button>
                        <button class="quick-btn" onclick="setOperation('åŠ å›é»„é‡‘è„†çš®é¸¡')">åŠ å›é»„é‡‘è„†çš®é¸¡</button>
                        <button class="quick-btn" onclick="setOperation('é»„é‡‘è„†çš®é¸¡æ”¹ä¸ºAAAé»„é‡‘è„†çš®é¸¡')">æ”¹åäº§å“</button>
                    </div>
                    <input type="text" id="operation" placeholder="ä¾‹å¦‚ï¼šåˆ é™¤é»„é‡‘è„†çš®é¸¡">
                </div>
        
                <button class="btn" onclick="submitRequest()" id="submitBtn">
                    å¼€å§‹ä¿®æ”¹
                </button>
            </div>
                    
            <!-- ä»»åŠ¡ä¿¡æ¯æ˜¾ç¤ºåŒºåŸŸ -->
            <div class="task-info-section" id="taskInfoSection" style="margin-bottom: 30px;">
                <div class="form-group">
                    <label>æ´»åŠ¨ç¼–ç ï¼š</label>
                    <input type="text" id="displayActivityCode" readonly style="background: #f5f5f5;">
                </div>
                <div class="form-group">
                    <label>æ“ä½œæŒ‡ä»¤ï¼š</label>
                    <input type="text" id="displayOperation" readonly style="background: #f5f5f5;">
                </div>
                <div class="form-group">
                    <label>åŸå§‹åˆ¸æ–‡æ¡ˆï¼š</label>
                    <textarea id="displayOriginalText" rows="12" readonly style="background: #f5f5f5;"></textarea>
                </div>
            </div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>AIæ­£åœ¨å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...</p>
            </div>

            <div class="result-section" id="resultSection">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div>
                        <span class="result-title">âœ… ä¿®æ”¹ç»“æœï¼š</span>
                        <span style="font-size: 12px; color: #ff9800; margin-left: 10px;">ï¼ˆä¿®æ”¹ç»“æœåçš„åŸå§‹æ–‡æ¡ˆåªæ˜¯è§‚å¯Ÿæ ¼å¼ä¿®æ”¹ï¼‰</span>
                    </div>
                    <select id="viewMode" class="view-mode-select" onchange="switchViewMode()">
                        <option value="modified">ä¿®æ”¹åçš„æ–‡æ¡ˆ</option>
                        <option value="original">åŸå§‹æ–‡æ¡ˆ</option>
                    </select>
                </div>
                <div class="result-box">
                    <div class="result-text" id="resultText"></div>
                </div>
                <div style="margin-top: 8px; font-size: 12px; color: #666;">
                    è¯´æ˜ï¼š<span style="background-color: #ffeb3b; padding: 1px 3px; border-radius: 2px;">é»„è‰²èƒŒæ™¯</span> è¡¨ç¤ºæ–‡æ¡ˆä¸­è¢«ä¿®æ”¹æˆ–éœ€è¦å…³æ³¨çš„å†…å®¹ã€‚
                </div>

                <div class="result-title">ğŸ“ ä¿®æ”¹ç‚¹è®°å½•ï¼š</div>
                <div style="margin-bottom: 15px; padding: 12px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px;">
                    <div style="font-weight: bold; color: #856404; margin-bottom: 8px;">ğŸ’¡ ä¸ºä»€ä¹ˆéœ€è¦æ·»åŠ åˆ°çŸ¥è¯†åº“ï¼Ÿ</div>
                    <div style="font-size: 13px; color: #856404; line-height: 1.6;">
                        å°†æˆåŠŸçš„ä¿®æ”¹æ¡ˆä¾‹ä¿å­˜åˆ°çŸ¥è¯†åº“åï¼ŒAIå°†åœ¨æœªæ¥å¤„ç†ç±»ä¼¼æ“ä½œæ—¶è‡ªåŠ¨å‚è€ƒè¿™äº›æ¡ˆä¾‹ï¼Œæé«˜å¤„ç†å‡†ç¡®æ€§å’Œä¸€è‡´æ€§ã€‚å»ºè®®å¯¹äºå¤æ‚æˆ–é¢‘ç¹çš„æ“ä½œéƒ½æ·»åŠ è‡³çŸ¥è¯†åº“ã€‚
                    </div>
                </div>
                <!-- ä¿®æ”¹ç±»å‹æ˜¾ç¤ºåŒºåŸŸ -->
                <div id="modificationType" style="display: none;"></div>
                <ul class="modification-list" id="modificationList"></ul>
                <div style="text-align: center; margin-top: 30px; display: flex; justify-content: center; align-items: center; gap: 20px;">
                    <!-- ä¸»è¦æŒ‰é’®ï¼šç¡®è®¤æ›´æ–°åˆ¸ä¿¡æ¯ -->
                    <button class="btn" id="updateCouponBtn" 
                            style="padding: 14px 40px; font-size: 16px; font-weight: bold; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);" disabled>
                        âœ… ç¡®è®¤æ›´æ–°åˆ¸ä¿¡æ¯
                    </button>
                    <!-- ç‰ˆæœ¬å›é€€åŒºåŸŸ -->
                    <div style="display: flex; flex-direction: column; gap: 10px; align-items: flex-start;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <label for="versionSelect" style="font-size: 14px; color: #666;">å†å²ç‰ˆæœ¬ï¼š</label>
                            <select id="versionSelect" onchange="previewVersion()" style="padding: 8px 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px; min-width: 200px;">
                                <option value="">è¯·é€‰æ‹©ç‰ˆæœ¬</option>
                            </select>
                        </div>
                        <!-- ç‰ˆæœ¬ä¿¡æ¯å’Œæ“ä½œåŒºåŸŸ -->
                        <div id="versionActions" style="display: none; background: #f9f9f9; padding: 15px; border-radius: 8px; border: 1px solid #e0e0e0; min-width: 400px;">
                            <div style="margin-bottom: 12px;">
                                <div style="font-size: 13px; color: #666; margin-bottom: 5px;">
                                    <strong>é€‰ä¸­ç‰ˆæœ¬ï¼š</strong><span id="selectedVersionText"></span>
                                </div>
                                <div style="font-size: 12px; color: #999;">
                                    <strong>åˆ›å»ºæ—¶é—´ï¼š</strong><span id="selectedVersionTime"></span>
                                </div>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn" onclick="showVersionPreview()" 
                                        style="padding: 8px 20px; font-size: 14px; background: #2196F3; color: white; border: none; flex: 1;">
                                    ğŸ“„ æŸ¥çœ‹å®Œæ•´å†…å®¹
                                </button>
                                <button class="btn" id="rollbackBtn" onclick="rollbackVersion()" 
                                        style="padding: 8px 20px; font-size: 14px; background: #ff9800; color: white; border: none; flex: 1;">
                                    â†©ï¸ å›é€€åˆ°æ­¤ç‰ˆæœ¬
                                </button>
                            </div>
                        </div>
                    </div>
                    <!-- æ¬¡è¦æŒ‰é’®ï¼šæ·»åŠ åˆ°çŸ¥è¯†åº“ -->
                    <button class="btn" id="addKbBtn" 
                            style="padding: 8px 16px; font-size: 13px; background: #e0e0e0; color: #666; border: 1px solid #ccc;" disabled>
                        â­ æ·»åŠ åˆ°çŸ¥è¯†åº“
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡å­˜å‚¨ç»“æœæ•°æ®
        let currentResult = null;
        let currentOriginalText = '';
        let pollingTimer = null; // è½®è¯¢å®šæ—¶å™¨
        let versionList = []; // å­˜å‚¨ç‰ˆæœ¬åˆ—è¡¨æ•°æ®
        
        // åŠ è½½åŸå§‹æ–‡æ¡ˆ
        async function loadOriginalText() {
            const activityCode = document.getElementById('activityCode').value.trim();
            
            if (!activityCode) {
                alert('è¯·è¾“å…¥æ´»åŠ¨ç¼–ç ï¼');
                return;
            }
            
            try {
                const response = await fetch(`/api/coupon/original/${activityCode}`);
                
                if (!response.ok) {
                    throw new Error('æœªæ‰¾åˆ°å¯¹åº”çš„æ´»åŠ¨ç¼–ç ');
                }
                
                const data = await response.json();
                
                if (data && data.description) {
                    document.getElementById('originalText').value = data.description;
                    alert('åŸæ–‡åŠ è½½æˆåŠŸï¼');
                } else {
                    alert('æœªæ‰¾åˆ°å¯¹åº”çš„åˆ¸æ–‡æ¡ˆ');
                }
            } catch (error) {
                alert('åŠ è½½å¤±è´¥ï¼š' + error.message);
            }
        }
        
        // è®¾ç½®å¿«æ·æ“ä½œ
        function setOperation(text) {
            document.getElementById('operation').value = text;
        }

        // æäº¤è¯·æ±‚
        async function submitRequest() {
            const activityCode = document.getElementById('activityCode').value.trim();
            const operation = document.getElementById('operation').value.trim();

            // éªŒè¯è¾“å…¥
            if (!activityCode) {
                alert('è¯·è¾“å…¥æ´»åŠ¨ç¼–ç ï¼');
                return;
            }

            if (!operation) {
                alert('è¯·è¾“å…¥æ“ä½œæŒ‡ä»¤ï¼');
                return;
            }
            
            // ä¿å­˜åŸå§‹æ–‡æ¡ˆï¼ˆä»è¾“å…¥æ¡†è·å–ï¼‰
            currentOriginalText = document.getElementById('originalText').value.trim();

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('loading').classList.add('show');
            document.getElementById('resultSection').classList.remove('show');
            document.getElementById('submitBtn').disabled = true;

            try {
                // å‘é€è¯·æ±‚
                const response = await fetch('/api/coupon/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        activityCode: activityCode,
                        operation: operation
                    })
                });

                const data = await response.json();

                if (data.success && data.taskId) {
                    // å¼€å§‹è½®è¯¢ä»»åŠ¡çŠ¶æ€
                    startPolling(data.taskId);
                } else {
                    // éšè—åŠ è½½çŠ¶æ€
                    document.getElementById('loading').classList.remove('show');
                    document.getElementById('submitBtn').disabled = false;
                    alert('ä»»åŠ¡åˆ›å»ºå¤±è´¥ï¼š' + (data.message || 'æœªçŸ¥é”™è¯¯'));
                }

            } catch (error) {
                document.getElementById('loading').classList.remove('show');
                document.getElementById('submitBtn').disabled = false;
                alert('è¯·æ±‚å¤±è´¥ï¼š' + error.message);
            }
        }
        
        // å¼€å§‹è½®è¯¢ä»»åŠ¡çŠ¶æ€
        function startPolling(taskId) {
            // æ¸…é™¤ä¹‹å‰çš„è½®è¯¢
            if (pollingTimer) {
                clearInterval(pollingTimer);
            }
            
            // æ¯ç§’è½®è¯¢ä¸€æ¬¡
            pollingTimer = setInterval(async () => {
                try {
                    const response = await fetch(`/api/coupon/task/${taskId}`);
                    const data = await response.json();
                    
                    if (data.status === 1) {
                        // å¤„ç†å®Œæˆ
                        clearInterval(pollingTimer);
                        pollingTimer = null;
                        
                        // éšè—åŠ è½½çŠ¶æ€
                        document.getElementById('loading').classList.remove('show');
                        document.getElementById('submitBtn').disabled = false;
                        
                        // å¯ç”¨çŸ¥è¯†åº“æŒ‰é’®å’Œæ›´æ–°åˆ¸ä¿¡æ¯æŒ‰é’®
                        const addKbBtn = document.getElementById('addKbBtn');
                        if (addKbBtn) {
                            addKbBtn.disabled = false;
                        }
                        const updateCouponBtn = document.getElementById('updateCouponBtn');
                        if (updateCouponBtn) {
                            updateCouponBtn.disabled = false;
                        }
                        
                        // æ˜¾ç¤ºç»“æœ
                        displayResult(data);
                        
                    } else if (data.status === 2) {
                        // å·²æ›´æ–°åˆ¸ä¿¡æ¯çŠ¶æ€ï¼Œæ˜¾ç¤ºç»“æœä½†ç¦ç”¨æ›´æ–°æŒ‰é’®
                        clearInterval(pollingTimer);
                        pollingTimer = null;
                        
                        // éšè—åŠ è½½çŠ¶æ€
                        document.getElementById('loading').classList.remove('show');
                        document.getElementById('submitBtn').disabled = false;
                        
                        // å¯ç”¨çŸ¥è¯†åº“æŒ‰é’®ï¼Œç¦ç”¨æ›´æ–°åˆ¸ä¿¡æ¯æŒ‰é’®
                        const addKbBtn = document.getElementById('addKbBtn');
                        if (addKbBtn) {
                            addKbBtn.disabled = false;
                        }
                        const updateCouponBtn = document.getElementById('updateCouponBtn');
                        if (updateCouponBtn) {
                            updateCouponBtn.disabled = true;
                            updateCouponBtn.textContent = 'âœ… å·²æ›´æ–°';
                        }
                        
                        // æ˜¾ç¤ºç»“æœ
                        displayResult(data);
                    } else if (data.status < 0) {
                        // å¤„ç†å¤±è´¥
                        clearInterval(pollingTimer);
                        pollingTimer = null;
                        
                        // éšè—åŠ è½½çŠ¶æ€
                        document.getElementById('loading').classList.remove('show');
                        document.getElementById('submitBtn').disabled = false;
                        
                        alert('å¤„ç†å¤±è´¥ï¼š' + (data.errorMessage || 'æœªçŸ¥é”™è¯¯'));
                    }
                    // status === 0 ç»§ç»­è½®è¯¢
                    
                } catch (error) {
                    console.error('æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€å¤±è´¥ï¼š', error);
                }
            }, 1000); // æ¯1ç§’æŸ¥è¯¢ä¸€æ¬¡
        }

        // æ˜¾ç¤ºç»“æœ
        function displayResult(data) {
            // ä¿å­˜ç»“æœæ•°æ®
            currentResult = data;
            
            // é‡ç½®ä¸ºæ˜¾ç¤ºä¿®æ”¹åçš„æ–‡æ¡ˆ
            document.getElementById('viewMode').value = 'modified';
            
            // æ˜¾ç¤ºä¿®æ”¹åçš„æ–‡æ¡ˆï¼ˆä¸å¸¦é«˜å…‰ï¼‰
            const cleanedCouponText = cleanText(data.couponText);
            document.getElementById('resultText').innerHTML = escapeHtml(cleanedCouponText);
            
            // æ˜¾ç¤ºä¿®æ”¹ç±»å‹ï¼ˆå¦‚æœæœ‰ï¼‰
            const modificationTypeDiv = document.getElementById('modificationType');
            if (modificationTypeDiv && data.modificationType) {
                modificationTypeDiv.innerHTML = `<div style="padding: 10px; background: #e7f3ff; border-left: 3px solid #2196F3; margin-bottom: 15px; border-radius: 4px;"><strong>ğŸ·ï¸ ä¿®æ”¹ç±»å‹ï¼š</strong>${escapeHtml(data.modificationType)}</div>`;
                modificationTypeDiv.style.display = 'block';
            } else if (modificationTypeDiv) {
                modificationTypeDiv.style.display = 'none';
            }

            // æ˜¾ç¤ºä¿®æ”¹ç‚¹
            const modificationList = document.getElementById('modificationList');
            modificationList.innerHTML = '';

            if (data.modificationPoints && data.modificationPoints.length > 0) {
                data.modificationPoints.forEach((point, index) => {
                    const li = document.createElement('li');
                    li.className = 'modification-item';
                    li.id = `mod-item-${index}`;
                    
                    let html = `
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div class="modification-label">ä¿®æ”¹ ${index + 1}</div>
                            <button class="edit-btn" onclick="toggleEdit(${index})">ç¼–è¾‘</button>
                        </div>
                    `;
                    
                    if (point.origin) {
                        const highlightedOrigin = highlightDifferences(point.origin, point.now);
                        html += `
                            <div class="modification-content">
                                <strong>åŸæ–‡ï¼š</strong>
                                <div class="display-text" id="origin-display-${index}">${highlightedOrigin}</div>
                                <textarea class="edit-text" id="origin-edit-${index}" style="display: none;">${escapeHtml(point.origin)}</textarea>
                            </div>
                        `;
                    }
                    
                    // æ˜¾ç¤ºâ€œæ”¹ä¸ºâ€ï¼šæ— è®ºæ˜¯ä¿®æ”¹ã€åˆ é™¤è¿˜æ˜¯æ–°å¢ï¼Œéƒ½è¦æ˜¾ç¤º
                    if (point.now) {
                        // æœ‰æ–°å†…å®¹ï¼šæ˜¾ç¤ºä¿®æ”¹åçš„æ–‡æ¡ˆ
                        const highlightedNow = highlightDifferences(point.now, point.origin);
                        html += `
                            <div class="modification-content" style="margin-top: 8px;">
                                <strong>æ”¹ä¸ºï¼š</strong>
                                <div class="display-text" id="now-display-${index}">${highlightedNow}</div>
                                <textarea class="edit-text" id="now-edit-${index}" style="display: none;">${escapeHtml(point.now)}</textarea>
                            </div>
                        `;
                    } else if (point.origin) {
                        // åªæœ‰åŸæ–‡æ²¡æœ‰æ–°å†…å®¹ï¼šæ˜¯åˆ é™¤æ“ä½œï¼Œæ˜¾ç¤ºâ€œæ”¹ä¸ºï¼šï¼ˆå·²åˆ é™¤ï¼‰â€
                        html += `
                            <div class="modification-content" style="margin-top: 8px;">
                                <strong>æ”¹ä¸ºï¼š</strong>
                                <div class="display-text" style="color: #e4002b; font-style: italic;">ï¼ˆå·²åˆ é™¤ï¼‰</div>
                                <textarea class="edit-text" id="now-edit-${index}" style="display: none;"></textarea>
                            </div>
                        `;
                    }
                    
                    if (!point.origin && point.now) {
                        html += `<div class="modification-content" style="color: #28a745;"><strong>æ“ä½œï¼š</strong>æ–°å¢</div>`;
                    }
                    
                    li.innerHTML = html;
                    modificationList.appendChild(li);
                });
            } else {
                modificationList.innerHTML = '<li class="modification-item">æ— ä¿®æ”¹è®°å½•</li>';
            }

            // æ˜¾ç¤ºç»“æœåŒºåŸŸ
            document.getElementById('resultSection').classList.add('show');

            // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
            document.getElementById('resultSection').scrollIntoView({ behavior: 'smooth' });
        }

        // HTMLè½¬ä¹‰ï¼ŒåŒæ—¶ä¿ç•™æ¢è¡Œï¼ˆ\n -> <br>ï¼‰
        function escapeHtml(text) {
            if (text == null) return '';
            const div = document.createElement('div');
            div.textContent = text;
            // å°†æ¢è¡Œç¬¦æ›¿æ¢ä¸º <br>ï¼Œä¿ç•™æ‰€æœ‰æ¢è¡Œï¼ˆåŒ…æ‹¬ç©ºè¡Œï¼‰
            return div.innerHTML.replace(/\n/g, '<br>');
        }
        
        // æ¸…ç†æ–‡æœ¬ï¼šå»é™¤æ¯è¡Œå¼€å¤´çš„ç©ºæ ¼ï¼Œä¿ç•™æ®µè½é—´çš„ç©ºè¡Œ
        function cleanText(text) {
            if (text == null) return '';
            // æŒ‰è¡Œåˆ†å‰²ï¼Œå»é™¤æ¯è¡Œå¼€å¤´çš„ç©ºæ ¼ï¼Œç„¶åé‡æ–°æ‹¼æ¥
            return text.split('\n').map(line => line.trimStart()).join('\n');
        }
        
        // é«˜äº®ä¸¤ä¸ªæ–‡æœ¬ä¹‹é—´çš„å·®å¼‚
        function highlightDifferences(text, compareText) {
            if (!text) return '';
            if (!compareText) return escapeHtml(text);
            
            // ç®€å•çš„å­—ç¬¦ä¸²åˆ†è¯ï¼ˆæŒ‰ä¸­æ–‡å­—ç¬¦ã€æ•°å­—ã€è‹±æ–‡å•è¯åˆ†å‰²ï¼‰
            const tokens1 = tokenize(text);
            const tokens2 = tokenize(compareText);
            
            // æ‰¾å‡ºå·®å¼‚çš„token
            const diffTokens = new Set();
            tokens1.forEach(token => {
                if (!tokens2.includes(token)) {
                    diffTokens.add(token);
                }
            });
            
            // é«˜äº®å·®å¼‚éƒ¨åˆ†
            let result = escapeHtml(text);
            
            // æŒ‰é•¿åº¦æ’åºï¼Œä»é•¿åˆ°çŸ­
            const sortedTokens = Array.from(diffTokens).sort((a, b) => b.length - a.length);
            
            sortedTokens.forEach(token => {
                const escapedToken = escapeHtml(token);
                const highlighted = `<span class="diff-highlight">${escapedToken}</span>`;
                result = result.replace(new RegExp(escapeRegExp(escapedToken), 'g'), highlighted);
            });
            
            return result;
        }
        
        // åˆ†è¯å‡½æ•°ï¼ˆç®€å•å®ç°ï¼‰
        function tokenize(text) {
            // åŒ¹é…ä¸­æ–‡å­—ç¬¦ã€æ•°å­—ã€è‹±æ–‡å•è¯ã€æ ‡ç‚¹ç¬¦å·ç­‰
            const regex = /[\u4e00-\u9fa5]+|[a-zA-Z]+|\d+|[^\u4e00-\u9fa5a-zA-Z\d\s]+/g;
            return text.match(regex) || [];
        }
        
        // å°† origin æ‹†åˆ†ä¸ºè¾ƒå°çš„å¥å­ç‰‡æ®µï¼Œç”¨äºæ›´ç²¾ç»†çš„é«˜äº®
        function splitIntoSegments(text) {
            if (!text) return [];
            const segments = [];
            // å…ˆæŒ‰æ¢è¡Œæ‹†åˆ†
            const lines = text.split(/\n+/);
            lines.forEach(line => {
                // å†æŒ‰å¥å·ã€é—®å·ã€æ„Ÿå¹å·ã€åˆ†å·æ‹†åˆ†
                const parts = line.split(/[ã€‚ï¼ï¼Ÿï¼›;]+/);
                parts.forEach(part => {
                    const seg = part.trim();
                    if (seg.length > 0) {
                        segments.push(seg);
                    }
                });
            });
            return segments;
        }
        
        // é«˜äº®ä¿®æ”¹çš„ç‰‡æ®µï¼ˆåœ¨åŸæ–‡ä¸­é«˜äº® origin å­—æ®µï¼‰
        function highlightModifications(text, modificationPoints) {
            if (!modificationPoints || modificationPoints.length === 0) {
                return escapeHtml(text);
            }
                    
            let result = escapeHtml(text);
            
            // æ”¶é›†æ‰€æœ‰éœ€è¦é«˜äº®çš„ç‰‡æ®µï¼ˆå°†æ¯ä¸ª origin æ‹†åˆ†ä¸ºæ›´å°çš„å¥å­ç‰‡æ®µï¼‰
            const highlightSegments = [];
            modificationPoints.forEach((point, index) => {
                if (point.origin && point.origin.trim()) {
                    const segments = splitIntoSegments(point.origin);
                    segments.forEach(seg => {
                        highlightSegments.push({
                            text: seg,
                            now: point.now || 'å·²åˆ é™¤',
                            index: index
                        });
                    });
                }
            });
                    
            // æŒ‰ç…§ç‰‡æ®µé•¿åº¦æ’åºï¼Œä»é•¿åˆ°çŸ­ï¼Œé¿å…çŸ­çš„åŒ¹é…å¹²æ‰°é•¿çš„
            highlightSegments.sort((a, b) => b.text.length - a.text.length);
                    
            // ä¸ºæ¯ä¸ªç‰‡æ®µæ·»åŠ é«˜å…‰ï¼ˆå¸¦dataå±æ€§å­˜å‚¨ä¿®æ”¹åçš„å†…å®¹å’Œç´¢å¼•ï¼‰
            highlightSegments.forEach(item => {
                const escapedSegment = escapeHtml(item.text);
                const modifiedText = escapeHtml(item.now);
                const modIndex = item.index;
                const highlightedSegment = `<span class="highlight" data-mod-index="${modIndex}">${escapedSegment}</span>`;
                result = result.replace(new RegExp(escapeRegExp(escapedSegment), 'g'), highlightedSegment);
            });
                    
            return result;
        }
        
        // è½¬ä¹‰æ­£åˆ™è¡¨è¾¾å¼ç‰¹æ®Šå­—ç¬¦
        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }
        
        // æ»šåŠ¨åˆ°å¯¹åº”çš„ä¿®æ”¹ç‚¹å¹¶é—ªçƒ
        function scrollToModification(event) {
            event.stopPropagation();
            const target = event.target;
            const modIndexAttr = target.getAttribute('data-mod-index');
            if (modIndexAttr == null) {
                return;
            }
            const modIndex = parseInt(modIndexAttr);
            
            // è·å–æ‰€æœ‰ä¿®æ”¹ç‚¹å…ƒç´ 
            const modificationItems = document.querySelectorAll('.modification-item');
            
            if (modIndex >= 0 && modIndex < modificationItems.length) {
                const targetItem = modificationItems[modIndex];
                
                // ç§»é™¤æ‰€æœ‰å…¶ä»–çš„flashæ•ˆæœ
                modificationItems.forEach(item => item.classList.remove('flash'));
                
                // æ»šåŠ¨åˆ°ç›®æ ‡å…ƒç´ 
                targetItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                // ç­‰å¾…æ»šåŠ¨å®Œæˆåæ·»åŠ é—ªçƒæ•ˆæœ
                setTimeout(() => {
                    targetItem.classList.add('flash');
                    
                    // åŠ¨ç”»ç»“æŸåç§»é™¤class
                    setTimeout(() => {
                        targetItem.classList.remove('flash');
                    }, 1200); // 0.6s * 2 = 1.2s
                }, 500);
            }
        }
        
        // ä¸ºé«˜äº®ç‰‡æ®µç»‘å®šç‚¹å‡»äº‹ä»¶ï¼Œç‚¹å‡»æ—¶å®šä½åˆ°å¯¹åº”ä¿®æ”¹ç‚¹
        function attachHighlightClickHandlers() {
            const resultText = document.getElementById('resultText');
            if (!resultText) return;
            const highlights = resultText.querySelectorAll('.highlight[data-mod-index]');
            highlights.forEach(span => {
                if (span.dataset.bound === '1') {
                    return;
                }
                span.dataset.bound = '1';
                span.addEventListener('click', scrollToModification);
            });
        }
        
        // åˆ‡æ¢æŸ¥çœ‹æ¨¡å¼
        function switchViewMode() {
            const viewMode = document.getElementById('viewMode').value;
            const resultText = document.getElementById('resultText');
            
            if (viewMode === 'original') {
                // æ˜¾ç¤ºåŸå§‹æ–‡æ¡ˆï¼ˆå¸¦é«˜å…‰ï¼Œé«˜äº®è¢«ä¿®æ”¹çš„éƒ¨åˆ†ï¼‰
                // æ¸…ç†æ–‡æœ¬ï¼šå»é™¤æ¯è¡Œå¼€å¤´çš„ç©ºæ ¼
                const cleanedText = cleanText(currentOriginalText);
                const highlightedText = highlightModifications(cleanedText, currentResult.modificationPoints);
                resultText.innerHTML = highlightedText;
                // ç»‘å®šç‚¹å‡»äº‹ä»¶ï¼Œå®ç°ä»åŸæ–‡é«˜äº®ç‰‡æ®µå®šä½åˆ°ä¸‹æ–¹ä¿®æ”¹ç‚¹
                attachHighlightClickHandlers();
            } else {
                // æ˜¾ç¤ºä¿®æ”¹åçš„æ–‡æ¡ˆï¼ˆä¸å¸¦é«˜å…‰ï¼‰
                if (currentResult) {
                    // æ¸…ç†æ–‡æœ¬ï¼šå»é™¤æ¯è¡Œå¼€å¤´çš„ç©ºæ ¼
                    const cleanedText = cleanText(currentResult.couponText);
                    resultText.innerHTML = escapeHtml(cleanedText);
                }
            }
        }
        
        // åˆ‡æ¢ç¼–è¾‘æ¨¡å¼
        function toggleEdit(index) {
            const btn = event.target;
            const originDisplay = document.getElementById(`origin-display-${index}`);
            const originEdit = document.getElementById(`origin-edit-${index}`);
            const nowDisplay = document.getElementById(`now-display-${index}`);
            const nowEdit = document.getElementById(`now-edit-${index}`);
            
            const isEditing = btn.classList.contains('active');
            
            if (isEditing) {
                // ä¿å­˜ç¼–è¾‘
                if (originEdit && originDisplay) {
                    const newOrigin = originEdit.value;
                    currentResult.modificationPoints[index].origin = newOrigin;
                    const highlightedOrigin = highlightDifferences(newOrigin, currentResult.modificationPoints[index].now);
                    originDisplay.innerHTML = highlightedOrigin;
                    originDisplay.style.display = 'block';
                    originEdit.style.display = 'none';
                }
                
                if (nowEdit && nowDisplay) {
                    const newNow = nowEdit.value;
                    currentResult.modificationPoints[index].now = newNow;
                    const highlightedNow = highlightDifferences(newNow, currentResult.modificationPoints[index].origin);
                    nowDisplay.innerHTML = highlightedNow;
                    nowDisplay.style.display = 'block';
                    nowEdit.style.display = 'none';
                }
                
                btn.textContent = 'ç¼–è¾‘';
                btn.classList.remove('active');
            } else {
                // å¼€å¯ç¼–è¾‘
                if (originDisplay && originEdit) {
                    originDisplay.style.display = 'none';
                    originEdit.style.display = 'block';
                }
                
                if (nowDisplay && nowEdit) {
                    nowDisplay.style.display = 'none';
                    nowEdit.style.display = 'block';
                }
                
                btn.textContent = 'ä¿å­˜';
                btn.classList.add('active');
            }
        }
        
        // ä¿å­˜åˆ°çŸ¥è¯†åº“
        async function saveToKnowledgeBase() {
            if (!currentResult || !currentResult.modificationPoints || currentResult.modificationPoints.length === 0) {
                alert('æ²¡æœ‰ä¿®æ”¹ç‚¹å¯ä»¥ä¿å­˜ï¼');
                return;
            }
            
            const operation = document.getElementById('displayOperation').value.trim();
            if (!operation) {
                alert('æ“ä½œæŒ‡ä»¤ä¸ºç©ºï¼Œæ— æ³•ä¿å­˜ï¼');
                return;
            }
            
            // å¼¹å‡ºç¡®è®¤å¯¹è¯æ¡†
            if (!confirm(`ç¡®è®¤è¦å°†æ­¤æ¬¡ä¿®æ”¹æ¡ˆä¾‹æ·»åŠ åˆ°çŸ¥è¯†åº“å—ï¼Ÿ

æ“ä½œæŒ‡ä»¤ï¼š${operation}
ä¿®æ”¹ç‚¹æ•°é‡ï¼š${currentResult.modificationPoints.length} æ¡

æ·»åŠ åï¼ŒAI å°†åœ¨å¤„ç†ç±»ä¼¼æ“ä½œæ—¶è‡ªåŠ¨å‚è€ƒæ­¤æ¡ˆä¾‹ã€‚`)) {
                return;
            }
            
            // æ„é€ resultï¼ˆJSONæ•°ç»„æ ¼å¼ï¼‰
            const result = currentResult.modificationPoints.map(point => ({
                origin: point.origin || '',
                now: point.now || ''
            }));
            
            // è·å–ä¿®æ”¹ç±»å‹ï¼ˆå¦‚æœæœ‰ï¼‰
            const modificationType = currentResult.modificationType || ''; // ä»è¿”å›çš„dataä¸­è·å–
            
            try {
                const response = await fetch('/api/knowledge/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        operation: operation,
                        type: modificationType, // æ·»åŠ typeå­—æ®µ
                        result: JSON.stringify(result)
                    })
                });
                
                if (response.ok) {
                    alert('âœ… æˆåŠŸæ·»åŠ åˆ°çŸ¥è¯†åº“ï¼');
                } else {
                    alert('â— æ·»åŠ å¤±è´¥ï¼Œè¯·é‡è¯•ï¼');
                }
            } catch (error) {
                alert('â— æ·»åŠ å¤±è´¥ï¼š' + error.message);
            }
        }
        
        // ä» URL è·å– taskId
        function getTaskIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('taskId');
        }
        
        // ç¡®è®¤æ›´æ–°åˆ¸ä¿¡æ¯
        async function updateCouponInfo() {
            const taskId = getTaskIdFromUrl();
            if (!taskId) {
                alert('ä»»åŠ¡IDä¸å­˜åœ¨ï¼');
                return;
            }
            
            if (!confirm('ç¡®è®¤å°†å½“å‰ä¿®æ”¹åçš„æ–‡æ¡ˆä½œä¸ºæ–°ç‰ˆæœ¬æ›´æ–°åˆ°åˆ¸ä¿¡æ¯åº“å—ï¼Ÿç‰ˆæœ¬å·å°†è‡ªåŠ¨+1ã€‚')) {
                return;
            }
            
            const updateBtn = document.getElementById('updateCouponBtn');
            updateBtn.disabled = true;
            updateBtn.textContent = 'æ­£åœ¨æ›´æ–°...';
            
            try {
                const response = await fetch(`/api/coupon/updateCouponInfo/${taskId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(`âœ… æ›´æ–°æˆåŠŸï¼\næ´»åŠ¨ç¼–ç : ${data.activityCode}\næ–°ç‰ˆæœ¬: ${data.newVersion}`);
                    updateBtn.textContent = 'âœ… å·²æ›´æ–°';
                    // åˆ·æ–°ç‰ˆæœ¬åˆ—è¡¨
                    await loadVersionList(data.activityCode);
                } else {
                    alert('â— æ›´æ–°å¤±è´¥ï¼š' + data.message);
                    updateBtn.disabled = false;
                    updateBtn.textContent = 'âœ… ç¡®è®¤æ›´æ–°åˆ¸ä¿¡æ¯';
                }
            } catch (error) {
                alert('â— æ›´æ–°å¤±è´¥ï¼š' + error.message);
                updateBtn.disabled = false;
                updateBtn.textContent = 'âœ… ç¡®è®¤æ›´æ–°åˆ¸ä¿¡æ¯';
            }
        }
        
        // åŠ è½½ç‰ˆæœ¬åˆ—è¡¨
        async function loadVersionList(activityCode) {
            try {
                const response = await fetch(`/api/coupon/versions/${activityCode}`);
                const versions = await response.json();
                
                // å­˜å‚¨ç‰ˆæœ¬æ•°æ®åˆ°å…¨å±€å˜é‡
                versionList = versions;
                
                const versionSelect = document.getElementById('versionSelect');
                versionSelect.innerHTML = '<option value="">è¯·é€‰æ‹©ç‰ˆæœ¬</option>';
                
                versions.forEach(v => {
                    const option = document.createElement('option');
                    option.value = v.version;
                    option.textContent = `ç‰ˆæœ¬ ${v.version} (${v.createTime})`;
                    versionSelect.appendChild(option);
                });
                
                // å¯ç”¨ç‰ˆæœ¬é€‰æ‹©å’Œå›é€€æŒ‰é’®
                versionSelect.disabled = false;
                const rollbackBtn = document.getElementById('rollbackBtn');
                rollbackBtn.disabled = false;
            } catch (error) {
                console.error('åŠ è½½ç‰ˆæœ¬åˆ—è¡¨å¤±è´¥', error);
            }
        }
        
        // ç‰ˆæœ¬é€‰æ‹©å˜åŒ–æ—¶æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯å’Œæ“ä½œæŒ‰é’®
        function previewVersion() {
            const versionSelect = document.getElementById('versionSelect');
            const selectedVersion = parseInt(versionSelect.value);
            const versionActions = document.getElementById('versionActions');
            
            if (!selectedVersion) {
                // æ²¡æœ‰é€‰æ‹©ç‰ˆæœ¬ï¼Œéšè—æ“ä½œåŒºåŸŸ
                versionActions.style.display = 'none';
                return;
            }
            
            // ä»å­˜å‚¨çš„ç‰ˆæœ¬æ•°æ®ä¸­æŸ¥æ‰¾
            const versionData = versionList.find(v => v.version === selectedVersion);
            
            if (versionData) {
                // æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯
                document.getElementById('selectedVersionText').textContent = `ç‰ˆæœ¬ ${versionData.version}`;
                document.getElementById('selectedVersionTime').textContent = versionData.createTime;
                
                // æ˜¾ç¤ºæ“ä½œåŒºåŸŸ
                versionActions.style.display = 'block';
            }
        }
        
        // æ˜¾ç¤ºç‰ˆæœ¬é¢„è§ˆ
        function showVersionPreview() {
            const versionSelect = document.getElementById('versionSelect');
            const selectedVersion = parseInt(versionSelect.value);
            
            if (!selectedVersion) {
                alert('è¯·é€‰æ‹©è¦æŸ¥çœ‹çš„ç‰ˆæœ¬ï¼');
                return;
            }
            
            // ä»å­˜å‚¨çš„ç‰ˆæœ¬æ•°æ®ä¸­æŸ¥æ‰¾
            const versionData = versionList.find(v => v.version === selectedVersion);
            
            if (!versionData) {
                alert('æœªæ‰¾åˆ°ç‰ˆæœ¬æ•°æ®ï¼');
                return;
            }
            
            // ä½¿ç”¨æ¨¡æ€æ¡†æ˜¾ç¤ºç‰ˆæœ¬å†…å®¹
            const cleanedDescription = cleanText(versionData.description);
            
            const modal = `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; justify-content: center; align-items: center;" onclick="closePreviewModal(event)">
                    <div style="background: white; padding: 30px; border-radius: 12px; max-width: 900px; max-height: 85vh; overflow-y: auto; box-shadow: 0 8px 32px rgba(0,0,0,0.3);" onclick="event.stopPropagation()">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #e0e0e0; padding-bottom: 15px;">
                            <div>
                                <h3 style="margin: 0 0 5px 0; color: #333; font-size: 20px;">ğŸ“„ ç‰ˆæœ¬ ${versionData.version} å†…å®¹é¢„è§ˆ</h3>
                                <div style="font-size: 13px; color: #999;">åˆ›å»ºæ—¶é—´ï¼š${versionData.createTime}</div>
                            </div>
                            <button onclick="closePreviewModal()" style="background: #e0e0e0; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px; color: #666;">âœ–ï¸ å…³é—­</button>
                        </div>
                        <div style="background: #f5f5f5; padding: 20px; border-radius: 8px; white-space: pre-wrap; line-height: 1.8; font-size: 14px; color: #333; border: 1px solid #e0e0e0; max-height: 50vh; overflow-y: auto;">${escapeHtml(cleanedDescription)}</div>
                        <div style="margin-top: 20px; display: flex; justify-content: space-between; align-items: center; padding-top: 15px; border-top: 1px solid #e0e0e0;">
                            <div style="font-size: 13px; color: #ff9800;">
                                âš ï¸ å›é€€åï¼Œæ­¤ç‰ˆæœ¬ä¹‹åçš„æ‰€æœ‰ç‰ˆæœ¬å°†è¢«åˆ é™¤
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button onclick="closePreviewModal()" style="background: #e0e0e0; color: #666; border: none; padding: 10px 24px; border-radius: 6px; cursor: pointer; font-size: 14px;">å–æ¶ˆ</button>
                                <button onclick="rollbackVersionFromModal(${versionData.version})" style="background: #ff9800; color: white; border: none; padding: 10px 24px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: bold;">â†©ï¸ å›é€€åˆ°æ­¤ç‰ˆæœ¬</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // æ·»åŠ æ¨¡æ€æ¡†åˆ°é¡µé¢
            const modalContainer = document.createElement('div');
            modalContainer.id = 'versionPreviewModal';
            modalContainer.innerHTML = modal;
            document.body.appendChild(modalContainer);
        }
        
        // å…³é—­é¢„è§ˆæ¨¡æ€æ¡†
        function closePreviewModal(event) {
            const modal = document.getElementById('versionPreviewModal');
            if (modal) {
                modal.remove();
            }
        }
        
        // ä»æ¨¡æ€æ¡†ç›´æ¥å›é€€ç‰ˆæœ¬
        async function rollbackVersionFromModal(version) {
            // å…³é—­æ¨¡æ€æ¡†
            closePreviewModal();
            
            // è°ƒç”¨å›é€€åŠŸèƒ½ï¼Œä½†ä¸éœ€è¦ä»ä¸‹æ‹‰æ¡†è·å–ç‰ˆæœ¬å·
            const activityCode = document.getElementById('displayActivityCode').value;
            
            if (!confirm(`ç¡®è®¤å›é€€åˆ°ç‰ˆæœ¬ ${version} å—ï¼Ÿ\n\næ³¨æ„ï¼šè¯¥ç‰ˆæœ¬ä¹‹åçš„æ‰€æœ‰ç‰ˆæœ¬å°†è¢«åˆ é™¤ï¼`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/coupon/rollback/${activityCode}/${version}`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(`âœ… å›é€€æˆåŠŸï¼\nå½“å‰ç‰ˆæœ¬ï¼š${data.version}`);
                    // é‡æ–°åŠ è½½ç‰ˆæœ¬åˆ—è¡¨å’ŒåŸå§‹æ–‡æ¡ˆ
                    await loadVersionList(activityCode);
                    await loadOriginalTextByCode(activityCode);
                    // é‡ç½®ä¸‹æ‹‰æ¡†å’Œéšè—æ“ä½œåŒºåŸŸ
                    document.getElementById('versionSelect').value = '';
                    document.getElementById('versionActions').style.display = 'none';
                    // å›é€€åï¼Œå°†æ›´æ–°åˆ¸ä¿¡æ¯æŒ‰é’®æ”¹å›å¯ç”¨çŠ¶æ€ï¼ˆå…è®¸ç»§ç»­ä¿®æ”¹ï¼‰
                    const updateCouponBtn = document.getElementById('updateCouponBtn');
                    if (updateCouponBtn) {
                        updateCouponBtn.disabled = false;
                        updateCouponBtn.textContent = 'âœ… ç¡®è®¤æ›´æ–°åˆ¸ä¿¡æ¯';
                    }
                } else {
                    alert('â— å›é€€å¤±è´¥ï¼š' + data.message);
                }
            } catch (error) {
                alert('â— å›é€€å¤±è´¥ï¼š' + error.message);
            }
        }
        
        // æ ¹æ® activityCode é‡æ–°åŠ è½½åŸå§‹æ–‡æ¡ˆ
        async function loadOriginalTextByCode(activityCode) {
            try {
                const response = await fetch(`/api/coupon/original/${activityCode}`);
                if (response.ok) {
                    const couponInfo = await response.json();
                    currentOriginalText = couponInfo.description;
                    document.getElementById('displayOriginalText').value = currentOriginalText;
                    // å¦‚æœå½“å‰æœ‰ç»“æœï¼Œæ›´æ–°æ˜¾ç¤º
                    if (currentResult) {
                        const viewMode = document.getElementById('viewMode').value;
                        if (viewMode === 'original') {
                            switchViewMode();
                        }
                    }
                }
            } catch (error) {
                console.error('åŠ è½½åŸå§‹æ–‡æ¡ˆå¤±è´¥', error);
            }
        }
        
        // ç‰ˆæœ¬å›é€€
        async function rollbackVersion() {
            const versionSelect = document.getElementById('versionSelect');
            const selectedVersion = versionSelect.value;
            
            if (!selectedVersion) {
                alert('è¯·é€‰æ‹©è¦å›é€€çš„ç‰ˆæœ¬ï¼');
                return;
            }
            
            // è·å– activityCode
            const activityCode = document.getElementById('displayActivityCode').value;
            if (!activityCode) {
                alert('æ´»åŠ¨ç¼–ç ä¸å­˜åœ¨ï¼');
                return;
            }
            
            if (!confirm(`ç¡®è®¤å›é€€åˆ°ç‰ˆæœ¬ ${selectedVersion} å—ï¼Ÿ\n\næ³¨æ„ï¼šè¯¥ç‰ˆæœ¬ä¹‹åçš„æ‰€æœ‰ç‰ˆæœ¬å°†è¢«åˆ é™¤ï¼`)) {
                return;
            }
            
            const rollbackBtn = document.getElementById('rollbackBtn');
            rollbackBtn.disabled = true;
            rollbackBtn.textContent = 'æ­£åœ¨å›é€€...';
            
            try {
                const response = await fetch(`/api/coupon/rollback/${activityCode}/${selectedVersion}`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(`âœ… å›é€€æˆåŠŸï¼\nå½“å‰ç‰ˆæœ¬ï¼š${data.version}`);
                    // åˆ·æ–°ç‰ˆæœ¬åˆ—è¡¨
                    await loadVersionList(activityCode);
                    // é‡æ–°åŠ è½½åŸå§‹æ–‡æ¡ˆ
                    await loadOriginalTextByCode(activityCode);
                    // é‡ç½®ä¸‹æ‹‰æ¡†å’Œéšè—æ“ä½œåŒºåŸŸ
                    versionSelect.value = '';
                    document.getElementById('versionActions').style.display = 'none';
                    // å›é€€åï¼Œå°†æ›´æ–°åˆ¸ä¿¡æ¯æŒ‰é’®æ”¹å›å¯ç”¨çŠ¶æ€ï¼ˆå…è®¸ç»§ç»­ä¿®æ”¹ï¼‰
                    const updateCouponBtn = document.getElementById('updateCouponBtn');
                    if (updateCouponBtn) {
                        updateCouponBtn.disabled = false;
                        updateCouponBtn.textContent = 'âœ… ç¡®è®¤æ›´æ–°åˆ¸ä¿¡æ¯';
                    }
                } else {
                    alert('â— å›é€€å¤±è´¥ï¼š' + data.message);
                }
                
                rollbackBtn.disabled = false;
                rollbackBtn.textContent = 'â†©ï¸ å›é€€åˆ°æ­¤ç‰ˆæœ¬';
            } catch (error) {
                alert('â— å›é€€å¤±è´¥ï¼š' + error.message);
                rollbackBtn.disabled = false;
                rollbackBtn.textContent = 'â†©ï¸ å›é€€åˆ°æ­¤ç‰ˆæœ¬';
            }
        }

        // é¡µé¢åŠ è½½æ—¶å¤„ç†
        window.onload = function() {
            // ç»‘å®šæŒ‰é’®ç‚¹å‡»äº‹ä»¶
            const updateCouponBtn = document.getElementById('updateCouponBtn');
            if (updateCouponBtn) {
                updateCouponBtn.addEventListener('click', updateCouponInfo);
                console.log('âœ… å·²ç»‘å®šæ›´æ–°åˆ¸ä¿¡æ¯æŒ‰é’®ç‚¹å‡»äº‹ä»¶');
            }
            
            const addKbBtn = document.getElementById('addKbBtn');
            if (addKbBtn) {
                addKbBtn.addEventListener('click', saveToKnowledgeBase);
                console.log('âœ… å·²ç»‘å®šæ·»åŠ åˆ°çŸ¥è¯†åº“æŒ‰é’®ç‚¹å‡»äº‹ä»¶');
            }
            
            // è·å–URLå‚æ•°
            const urlParams = new URLSearchParams(window.location.search);
            const taskId = urlParams.get('taskId');
            
            if (taskId) {
                // å¦‚æœæœ‰taskIdï¼ŒåŠ è½½ä»»åŠ¡è¯¦æƒ…
                loadTaskDetail(taskId);
            } else {
                // é»˜è®¤å¡«å……æµ‹è¯•æ•°æ®
                document.getElementById('activityCode').value = 'TEST001';
                document.getElementById('operation').value = 'åˆ é™¤é»„é‡‘è„†çš®é¸¡';
            }
        };
        
        // åŠ è½½ä»»åŠ¡è¯¦æƒ…
        async function loadTaskDetail(taskId) {
            try {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                document.getElementById('loading').classList.add('show');
                
                const response = await fetch(`/api/coupon/task/${taskId}`);
                const data = await response.json();
                
                // éšè—åŠ è½½çŠ¶æ€
                document.getElementById('loading').classList.remove('show');
                
                if (data.status === 0) {
                    // å¤„ç†ä¸­ï¼Œæ˜¾ç¤ºåŸå§‹æ–‡æ¡ˆå’ŒåŠ è½½çŠ¶æ€
                    document.getElementById('displayActivityCode').value = data.subScene || '';
                    document.getElementById('displayOperation').value = data.scene || '';
                    
                    // ç¦ç”¨çŸ¥è¯†åº“æŒ‰é’®å’Œæ›´æ–°åˆ¸ä¿¡æ¯æŒ‰é’®ï¼ˆæœªå®Œæˆå‰ä¸å¯ç‚¹å‡»ï¼‰
                    const addKbBtn = document.getElementById('addKbBtn');
                    if (addKbBtn) {
                        addKbBtn.disabled = true;
                    }
                    const updateCouponBtn = document.getElementById('updateCouponBtn');
                    if (updateCouponBtn) {
                        updateCouponBtn.disabled = true;
                    }
                    
                    // æ˜¾ç¤ºåŸå§‹æ–‡æ¡ˆ
                    if (data.originalText) {
                        currentOriginalText = data.originalText;
                        document.getElementById('displayOriginalText').value = currentOriginalText;
                    }
                    
                    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€å’Œæç¤º
                    document.getElementById('loading').classList.add('show');
                    document.getElementById('resultSection').classList.add('show');
                    document.getElementById('resultText').innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">ğŸ¤– AIæ­£åœ¨å¤„ç†ä¸­ï¼Œè¯·ç¨å...</div>';
                    
                    // å¼€å§‹è½®è¯¢
                    startPolling(taskId);
                } else if (data.status === 1) {
                    // å¤„ç†å®Œæˆï¼Œæ˜¾ç¤ºç»“æœ
                    // å¡«å……æ“ä½œä¿¡æ¯
                    document.getElementById('displayActivityCode').value = data.subScene || '';
                    document.getElementById('displayOperation').value = data.scene || '';
                    
                    // å¯ç”¨çŸ¥è¯†åº“æŒ‰é’®å’Œæ›´æ–°åˆ¸ä¿¡æ¯æŒ‰é’®ï¼ˆä»»åŠ¡å®Œæˆåå…è®¸æ“ä½œï¼‰
                    const addKbBtn = document.getElementById('addKbBtn');
                    if (addKbBtn) {
                        addKbBtn.disabled = false;
                    }
                    const updateCouponBtn = document.getElementById('updateCouponBtn');
                    if (updateCouponBtn) {
                        updateCouponBtn.disabled = false;
                    }
                    
                    // åŠ è½½åŸæ–‡ï¼ˆå¦‚æœæœ‰activityCodeï¼‰
                    if (data.subScene) {
                        const originalResponse = await fetch(`/api/coupon/original/${data.subScene}`);
                        if (originalResponse.ok) {
                            const couponInfo = await originalResponse.json();
                            currentOriginalText = couponInfo.description;
                            document.getElementById('displayOriginalText').value = currentOriginalText;
                        }
                        // åŠ è½½ç‰ˆæœ¬åˆ—è¡¨
                        await loadVersionList(data.subScene);
                    }
                    
                    // æ˜¾ç¤ºç»“æœ
                    displayResult(data);
                } else if (data.status === 2) {
                    // å·²æ›´æ–°åˆ¸ä¿¡æ¯çŠ¶æ€ï¼Œæ˜¾ç¤ºç»“æœä½†ç¦ç”¨æ›´æ–°æŒ‰é’®
                    // å¡«å……æ“ä½œä¿¡æ¯
                    document.getElementById('displayActivityCode').value = data.subScene || '';
                    document.getElementById('displayOperation').value = data.scene || '';
                    
                    // å¯ç”¨çŸ¥è¯†åº“æŒ‰é’®ï¼Œç¦ç”¨æ›´æ–°åˆ¸ä¿¡æ¯æŒ‰é’®
                    const addKbBtn = document.getElementById('addKbBtn');
                    if (addKbBtn) {
                        addKbBtn.disabled = false;
                    }
                    const updateCouponBtn = document.getElementById('updateCouponBtn');
                    if (updateCouponBtn) {
                        updateCouponBtn.disabled = true;
                        updateCouponBtn.textContent = 'âœ… å·²æ›´æ–°';
                    }
                    
                    // åŠ è½½åŸæ–‡ï¼ˆå¦‚æœæœ‰activityCodeï¼‰
                    if (data.subScene) {
                        const originalResponse = await fetch(`/api/coupon/original/${data.subScene}`);
                        if (originalResponse.ok) {
                            const couponInfo = await originalResponse.json();
                            currentOriginalText = couponInfo.description;
                            document.getElementById('displayOriginalText').value = currentOriginalText;
                        }
                        // åŠ è½½ç‰ˆæœ¬åˆ—è¡¨
                        await loadVersionList(data.subScene);
                    }
                    
                    // æ˜¾ç¤ºç»“æœ
                    displayResult(data);
                } else if (data.status < 0) {
                    // ä»»åŠ¡å¤„ç†å¤±è´¥
                    alert('ä»»åŠ¡å¤„ç†å¤±è´¥ï¼š' + (data.errorMessage || 'æœªçŸ¥é”™è¯¯'));
                }
                
            } catch (error) {
                document.getElementById('loading').classList.remove('show');
                alert('åŠ è½½ä»»åŠ¡è¯¦æƒ…å¤±è´¥ï¼š' + error.message);
            }
        }
        
        // è¿”å›ä»»åŠ¡åˆ—è¡¨
        function backToTasks() {
            window.location.href = '/tasks.html';
        }
    </script>
</body>
</html>
